<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Remote File Explorer</title>
  <style>
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, Noto Sans;
      margin: 0;
    }

    .app {
      padding: 16px;
      max-width: 1200px;
      margin: 0 auto;
    }

    h2 {
      margin: 12px 0;
    }

    h3 {
      margin: 8px 0;
      font-size: 1.1em;
      color: #4b5563;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }

    th,
    td {
      padding: 8px 10px;
      border-bottom: 1px solid #f3f4f6;
      text-align: left;
      vertical-align: middle;
    }

    tbody tr:hover {
      background: #f8fafc;
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin: 12px 0 24px 0;
    }

    .card {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
      background: #fff;
    }

    .muted {
      color: #6b7280;
      font-size: 12px;
    }

    .toolbar {
      display: flex;
      gap: 8px;
      align-items: center;
      margin: 8px 0;
    }

    button {
      padding: 6px 10px;
      cursor: pointer;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      transition: background 0.15s ease, transform 0.02s ease;
    }

    button:hover {
      background: #e9ebef;
    }

    button:active {
      background: #e1e4e8;
      transform: translateY(1px);
    }

    .btn-sm {
      padding: 4px 8px;
      font-size: 12px;
    }

    .btn-danger {
      color: #dc2626;
      background: #fee2e2;
      border-color: #fca5a5;
    }

    .btn-danger:hover {
      background: #fecaca;
    }

    .btn-success {
      color: #16a34a;
      background: #dcfce7;
      border-color: #86efac;
    }

    .btn-success:hover {
      background: #bbf7d0;
    }

    .btn-primary {
      color: #ffffff;
      background: #2563eb;
      border-color: #2563eb;
    }

    .btn-primary:hover {
      background: #1d4ed8;
    }

    .status-running {
      color: #16a34a;
      font-weight: bold;
    }

    .status-stopped {
      color: #dc2626;
    }

    .tabs {
      display: flex;
      gap: 8px;
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 16px;
    }

    .tab {
      padding: 8px 16px;
      cursor: pointer;
      border-radius: 4px 4px 0 0;
    }

    .tab.active {
      background: #f3f4f6;
      font-weight: bold;
      border-bottom: 2px solid #2563eb;
    }

    .progress-bg {
      background: #e5e7eb;
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      width: 100%;
    }

    .progress-fill {
      background: #2563eb;
      height: 100%;
      transition: width 0.3s;
    }

    .progress-fill.high {
      background: #dc2626;
    }

    .progress-fill.med {
      background: #eab308;
    }

    /* Automation Styles */
    .script-card {
      position: relative;
      border-left: 4px solid transparent;
    }

    .script-card.blue {
      border-left-color: #3b82f6;
    }

    .script-card.green {
      border-left-color: #22c55e;
    }

    .script-card.red {
      border-left-color: #ef4444;
    }

    .script-card .title {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 4px;
    }

    .script-card .desc {
      font-size: 13px;
      color: #6b7280;
      min-height: 40px;
      margin-bottom: 8px;
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal {
      background: #fff;
      width: 800px;
      max-width: 90%;
      max-height: 80vh;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .modal-header {
      padding: 12px 16px;
      border-bottom: 1px solid #e5e7eb;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
    }

    .modal-body {
      padding: 0;
      background: #1e1e1e;
      color: #d4d4d4;
      flex: 1;
      overflow: auto;
      font-family: monospace;
      font-size: 13px;
      white-space: pre-wrap;
    }

    .modal-body-content {
      padding: 16px;
    }

    .modal-footer {
      padding: 12px 16px;
      border-top: 1px solid #e5e7eb;
      text-align: right;
    }

    a {
      color: #2563eb;
      text-decoration: none;
    }

    /* Dark mode */
    body.dark {
      background: #0f172a;
      color: #e5e7eb;
    }

    body.dark th,
    body.dark td {
      border-color: #1f2937
    }

    body.dark tbody tr:hover {
      background: #0b1220
    }

    body.dark .card {
      background: #0f172a;
      border-color: #1f2937
    }

    body.dark button {
      background: #0b1220;
      color: #e5e7eb;
      border: 1px solid #1f2937
    }

    body.dark button:hover {
      background: #0e1526
    }

    body.dark button:active {
      background: #0a1120
    }

    body.dark .tab.active {
      background: #1e293b;
      border-bottom-color: #3b82f6;
    }

    body.dark .progress-bg {
      background: #374151;
    }

    body.dark .modal {
      background: #1e293b;
      border-color: #374151;
    }

    body.dark .modal-header,
    body.dark .modal-footer {
      border-color: #374151;
    }

    .table-container {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
    }

    body.dark .table-container {
      border-color: #374151;
    }

    .sticky-th {
      position: sticky;
      top: 0;
      background: #f9fafb;
      z-index: 1;
    }

    body.dark .sticky-th {
      background: #1e293b;
      border-bottom-color: #374151;
    }
  </style>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://unpkg.com/axios@1.7.7/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- xterm.js -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
</head>

<body>
  <div id="app" class="app">
    <div class="toolbar">
      <a href="/index.html">← Back to Explorer</a>
      <span style="flex:1"></span>
      <button @click="toggleTheme">{{ theme === 'dark' ? 'Light' : 'Dark' }}</button>
    </div>

    <!-- Dashboard Cards -->
    <h2>System Dashboard</h2>
    <div class="cards">
      <div class="card">
        <div class="muted" style="display:flex; justify-content:space-between; align-items:center;">
          <span>CPU Usage</span>
          <div style="display:flex; gap:4px">
            <span
              style="background:#e5e7eb; color:#374151; font-size:10px; padding:2px 6px; border-radius:4px; font-weight:bold;"
              title="Server Process ID">PID {{ stats.server_pid }}</span>
            <span v-if="stats.is_admin"
              style="background:#dcfce7; color:#166534; font-size:10px; padding:2px 6px; border-radius:4px; font-weight:bold;">ADMIN</span>
            <span v-else
              style="background:#fee2e2; color:#991b1b; font-size:10px; padding:2px 6px; border-radius:4px; font-weight:bold;">USER</span>
          </div>
        </div>
        <div style="font-size:24px; font-weight:700">{{ stats.cpu_percent }}%</div>
        <div class="progress-bg">
          <div class="progress-fill" :class="getUsageClass(stats.cpu_percent)"
            :style="{width: stats.cpu_percent + '%'}"></div>
        </div>
      </div>
      <div class="card">
        <div class="muted">RAM Usage</div>
        <div style="font-size:24px; font-weight:700">{{ stats.memory_percent }}%</div>
        <div class="muted">{{ formatBytes(stats.memory_used) }} / {{ formatBytes(stats.memory_total) }}</div>
        <div class="progress-bg">
          <div class="progress-fill" :class="getUsageClass(stats.memory_percent)"
            :style="{width: stats.memory_percent + '%'}"></div>
        </div>
      </div>
      <div class="card">
        <div class="muted">Disk ({{ stats.disk_percent }}%)</div>
        <div style="font-size:24px; font-weight:700">{{ formatBytes(stats.disk_free) }} Free</div>
        <div class="muted">Total: {{ formatBytes(stats.disk_total) }}</div>
      </div>
      <div class="card">
        <div class="muted">Network Speed (KB/s)</div>
        <div style="font-size:18px; font-weight:700" title="Download / Upload">
          ↓{{ netSpeed?.recv || 0 }} / ↑{{ netSpeed?.sent || 0 }}
        </div>
      </div>
      <div class="card">
        <div class="muted">Shares / Pins</div>
        <div style="font-size:24px; font-weight:700">{{ summary.shares }} / {{ summary.pins }}</div>
      </div>
    </div>

    <div class="tabs">
      <div class="tab" :class="{active: tab === 'services'}" @click="tab = 'services'">Services</div>
      <div class="tab" :class="{active: tab === 'processes'}" @click="tab = 'processes'">Processes</div>
      <div class="tab" :class="{active: tab === 'terminal'}" @click="tab = 'terminal'">Terminal</div>
      <div class="tab" :class="{active: tab === 'logs'}" @click="tab = 'logs'">Logs</div>
      <div class="tab" :class="{active: tab === 'performance'}" @click="tab = 'performance'">Performance</div>
      <div class="tab" :class="{active: tab === 'automation'}" @click="tab = 'automation'">Automation Hub</div>
      <div class="tab" :class="{active: tab === 'database'}" @click="tab = 'database'">Database</div>
    </div>

    <!-- Terminal Tab -->
    <div v-show="tab === 'terminal'" style="height: 600px; display:flex; flex-direction:column;">
      <div class="toolbar" style="margin-bottom: 8px;">
        <h3>Web Terminal</h3>
        <span class="muted" style="margin-left: 10px; font-size: 0.9em;">(cmd.exe / powershell)</span>
        <span style="flex:1"></span>
        <button class="btn-sm" @click="fitTerminal">Fit Window</button>
        <button class="btn-sm btn-danger" @click="restartTerminal">Reconnect</button>
      </div>
      <div id="terminal-container"
        style="flex:1; background: #000; padding: 4px; border-radius: 4px; overflow: hidden; border: 1px solid #374151;">
      </div>
    </div>

    <!-- Logs Tab -->
    <div v-show="tab === 'logs'" style="height: 600px; display:flex; flex-direction:column;">
      <div class="toolbar"
        style="margin-bottom: 8px; border-bottom:1px solid #333; background:#252526; padding:8px; display:flex; align-items:center">
        <h3 style="margin:0; color:#ccc">Live Logs</h3>
        <span style="flex:1"></span>
        <div style="display:flex; gap:8px">
          <label style="color:#ccc; font-size:12px; display:flex; align-items:center; gap:4px"><input type="checkbox"
              v-model="logs.autoScroll"> Auto-scroll</label>
          <button class="btn-sm" @click="logs.content = ''">Clear</button>
          <button class="btn-sm" :class="logs.connected ? 'btn-danger' : 'btn-success'" @click="toggleLogs">{{
            logs.connected ? 'Disconnect' : 'Connect' }}</button>
        </div>
      </div>
      <pre ref="logContainer"
        style="flex:1; background:#1e1e1e; color:#d4d4d4; padding:12px; margin:0; overflow:auto; font-family:Consolas, monospace; font-size:13px; line-height:1.4; white-space:pre-wrap; border:1px solid #374151; border-radius:4px">{{ logs.content }}</pre>
    </div>

    <!-- Services Tab -->
    <div v-if="tab === 'services'">
      <div class="toolbar">
        <h3>Windows Services</h3>
        <button class="btn-sm" @click="loadServices">Refresh</button>
      </div>
      <input type="text" v-model="serviceFilter" placeholder="Filter services..."
        style="padding:6px; margin-bottom:12px; width:200px; border:1px solid #ccc; border-radius:4px;">
      <div style="max-height: 500px; overflow-y: auto;">
        <table>
          <thead>
            <tr>
              <th>Display Name</th>
              <th>Name</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="svc in filteredServices" :key="svc.name">
              <td>{{ svc.display_name }}</td>
              <td style="font-family: monospace; font-size: 0.9em;">{{ svc.name }}</td>
              <td>
                <span :class="{'status-running': svc.status === 'running', 'status-stopped': svc.status === 'stopped'}">
                  {{ svc.status }}
                </span>
              </td>
              <td>
                <button v-if="svc.status === 'running'" class="btn-sm btn-danger"
                  @click="svcAction(svc.name, 'stop')">Stop</button>
                <button v-if="svc.status === 'stopped'" class="btn-sm btn-success"
                  @click="svcAction(svc.name, 'start')">Start</button>
                <button v-if="svc.status === 'running'" class="btn-sm"
                  @click="svcAction(svc.name, 'restart')">Restart</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Processes Tab -->
    <div v-if="tab === 'processes'">
      <div class="toolbar">
        <h3>Top Processes (by RAM)</h3>
        <button class="btn-sm" @click="loadProcesses">Refresh</button>
      </div>
      <div style="margin-bottom:12px">
        <input type="text" v-model="processFilter" placeholder="Filter processes (Name or PID)..."
          style="padding:6px; width:220px; border:1px solid #ccc; border-radius:4px;">
      </div>
      <!-- Apps Section -->
      <h4 style="margin: 16px 0 8px 0; border-bottom: 2px solid #2563eb; display:inline-block; padding-bottom:4px;">Apps
        ({{ apps.length }})</h4>
      <div class="table-container">
        <table style="margin-bottom: 0;">
          <thead>
            <tr>
              <th class="sticky-th">PID</th>
              <th class="sticky-th">Name</th>
              <th class="sticky-th">User</th>
              <th class="sticky-th">Memory</th>
              <th class="sticky-th">CPU</th>
              <th class="sticky-th">Action</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="p in apps" :key="p.pid">
              <td style="font-family:monospace">{{ p.pid }}</td>
              <td style="font-weight:bold">{{ p.name }}</td>
              <td>{{ p.username }}</td>
              <td>{{ p.memory_mb }} MB</td>
              <td>{{ p.cpu_percent }}%</td>
              <td>
                <button class="btn-sm btn-danger" @click="killProcess(p.pid)">Kill</button>
              </td>
            </tr>
            <tr v-if="apps.length === 0">
              <td colspan="6" class="muted">No active apps found.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Background Processes Section -->
      <h4 style="margin: 24px 0 8px 0; border-bottom: 2px solid #6b7280; display:inline-block; padding-bottom:4px;">
        Background Processes ({{ backgroundProcesses.length }})</h4>
      <div class="table-container">
        <table style="margin-bottom: 0;">
          <thead>
            <tr>
              <th class="sticky-th">PID</th>
              <th class="sticky-th">Name</th>
              <th class="sticky-th">User</th>
              <th class="sticky-th">Memory</th>
              <th class="sticky-th">CPU</th>
              <th class="sticky-th">Action</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="p in backgroundProcesses" :key="p.pid">
              <td style="font-family:monospace">{{ p.pid }}</td>
              <td>{{ p.name }}</td>
              <td>{{ p.username }}</td>
              <td>{{ p.memory_mb }} MB</td>
              <td>{{ p.cpu_percent }}%</td>
              <td>
                <button class="btn-sm btn-danger" @click="killProcess(p.pid)">Kill</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Performance Tab -->
    <div v-if="tab === 'performance'">
      <div class="toolbar">
        <h3>Realtime Performance</h3>
        <div class="muted">Update Interval: 0.5s</div>
      </div>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
        <div class="card">
          <div class="muted">CPU Usage (%)</div>
          <canvas id="chartCpu"></canvas>
        </div>
        <div class="card">
          <div class="muted">Memory Usage (%)</div>
          <canvas id="chartMem"></canvas>
        </div>
        <div class="card">
          <div class="muted">Disk Usage (%)</div>
          <canvas id="chartDisk"></canvas>
        </div>
        <div class="card">
          <div class="muted">Network (KB/s)</div>
          <canvas id="chartNet"></canvas>
        </div>
      </div>
    </div>

    <!-- Automation Tab -->
    <div v-if="tab === 'automation'">
      <div class="toolbar">
        <h3>Available Scripts</h3>
        <button class="btn-sm" @click="loadScripts">Refresh</button>
      </div>
      <div class="cards">
        <div v-for="s in scripts" :key="s.filename" class="card script-card" :class="s.color">
          <div class="title">{{ s.name }}</div>
          <div class="desc">{{ s.description || s.filename }}</div>
          <div class="toolbar">
            <span class="muted" style="flex:1">{{ s.type.toUpperCase() }}</span>
            <button class="btn-sm btn-primary" @click="runScript(s.filename)">Run Now</button>
          </div>
        </div>
        <div v-if="scripts.length === 0" class="muted" style="grid-column: 1/-1;">No scripts found in server_scripts/
        </div>
      </div>

      <h3 style="margin-top:24px">Recent Job History</h3>
      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Script</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="job in jobHistory" :key="job.id">
            <td>{{ formatTime(new Date(job.start_time).getTime()/1000) }}</td>
            <td>{{ job.script }}</td>
            <td>
              <span :style="{color: job.status=='success'?'green':(job.status=='failed'?'red':'orange')}">
                {{ job.status.toUpperCase() }}
              </span>
            </td>
            <td>
              <button class="btn-sm" @click="openJob(job.id)">View Log</button>
              <button class="btn-sm btn-danger" @click="delJob(job.id)">✕</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Database Tab -->
    <div v-if="tab === 'database'">
      <h3>Shares</h3>
      <div class="muted">Manage existing share links.</div>
      <table>
        <thead>
          <tr>
            <th>Token</th>
            <th>Root</th>
            <th>Readonly</th>
            <th>Allow Download</th>
            <th>Allow Edit</th>
            <th>Expires</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="s in shares" :key="s.token">
            <td style="font-family:ui-monospace">{{ s.token }}</td>
            <td>{{ s.root }}</td>
            <td>{{ s.readonly ? 'Yes' : 'No' }}</td>
            <td>{{ s.allow_download ? 'Yes' : 'No' }}</td>
            <td>{{ s.allow_edit ? 'Yes' : 'No' }}</td>
            <td>{{ formatTime(s.expires_at) }}</td>
            <td>
              <button @click="delShare(s.token)">Delete</button>
            </td>
          </tr>
          <tr v-if="shares.length === 0">
            <td colspan="7" class="muted">No data</td>
          </tr>
        </tbody>
      </table>

      <h3 style="margin-top:20px">Pins</h3>
      <div class="muted">Pinned folders persisted in DB.</div>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Path</th>
            <th>Created</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="p in pins" :key="p.id">
            <td>{{ p.id }}</td>
            <td>{{ p.path }}</td>
            <td>{{ formatTime(p.created_at) }}</td>
            <td>
              <button @click="delPin(p.id)">Delete</button>
            </td>
          </tr>
          <tr v-if="pins.length === 0">
            <td colspan="4" class="muted">No data</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Console/Log Modal -->
    <div v-if="showModal" class="modal-overlay" @click.self="closeModal">
      <div class="modal">
        <div class="modal-header">
          <span>Job: {{ currentJob?.script }}</span>
          <span>Status: {{ currentJob?.status }}</span>
        </div>
        <div class="modal-body" ref="logBody">
          <div class="modal-body-content">{{ currentJob?.log }}</div>
        </div>
        <div class="modal-footer">
          <button @click="closeModal">Close</button>
        </div>
      </div>
    </div>

  </div>
  <script>
    axios.interceptors.response.use(
      response => response,
      error => {
        if (error.response && error.response.status === 401) {
          window.location.href = '/login.html';
        }
        return Promise.reject(error);
      }
    );
  </script>
  <script>
    const { createApp, ref, onMounted, computed, watch, nextTick, reactive } = Vue
    createApp({
      setup() {
        const tab = ref('automation')
        const summary = ref({ shares: 0, pins: 0 })
        const stats = ref({ cpu_percent: 0, memory_percent: 0, memory_used: 0, memory_total: 0, disk_percent: 0, disk_free: 0, disk_total: 0, net_sent: 0, net_recv: 0, is_admin: false, server_pid: 0 })
        const netSpeed = ref({ sent: 0, recv: 0 })

        const shares = ref([])
        const pins = ref([])

        const services = ref([])
        const serviceFilter = ref('')

        const processes = ref([])
        const processFilter = ref('')

        const scripts = ref([])
        const jobHistory = ref([])
        const showModal = ref(false)
        const currentJob = ref(null)
        let pollInterval = null
        const logBody = ref(null)

        const apps = computed(() => processes.value.filter(p => p.is_app && (
          p.name.toLowerCase().includes(processFilter.value.toLowerCase()) ||
          String(p.pid).includes(processFilter.value)
        )))

        const backgroundProcesses = computed(() => processes.value.filter(p => !p.is_app && (
          p.name.toLowerCase().includes(processFilter.value.toLowerCase()) ||
          String(p.pid).includes(processFilter.value)
        )))

        const theme = ref('light')

        // Terminal Refs
        let term = null
        let fitAddon = null
        let ws = null

        // Logs
        const logs = reactive({ content: '', connected: false, autoScroll: true })
        let logWs = null
        const logContainer = ref(null)

        function toggleLogs() {
          if (logs.connected) {
            if (logWs) logWs.close()
            logs.connected = false
          } else {
            initLogs()
          }
        }

        function initLogs() {
          if (logs.connected) return
          const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
          const wsUrl = `${protocol}//${window.location.host}/api/ws/logs`;
          logWs = new WebSocket(wsUrl);
          logWs.onopen = () => {
            logs.connected = true
            logs.content += '[Logs Connected]\n'
          }
          logWs.onmessage = (ev) => {
            logs.content += ev.data
            if (logs.autoScroll && logContainer.value) {
              nextTick(() => {
                logContainer.value.scrollTop = logContainer.value.scrollHeight
              })
            }
          }
          logWs.onclose = () => {
            logs.connected = false
            logs.content += '\n[Logs Disconnected]'
          }
          logWs.onerror = () => {
            logs.connected = false
            logs.content += '\n[Connection Error]'
          }
        }

        // --- Loaders ---
        // --- Charts ---
        let charts = {}
        const MAX_POINTS = 30
        let lastNet = { sent: 0, recv: 0, time: Date.now() }

        function initCharts() {
          if (tab.value !== 'performance') return
          nextTick(() => {
            if (charts.cpu) return // already init

            const commonOptions = {
              responsive: true,
              animation: false, // Instant update for reliable "scroll" without morphing
              scales: { x: { display: false }, y: { beginAtZero: true, max: 100 } },
              elements: { point: { radius: 0 }, line: { tension: 0.1 } }, // Low tension for technical feel
              plugins: { legend: { display: false } }
            }

            const createChart = (id, color, label, max = 100) => {
              const ctx = document.getElementById(id)
              if (!ctx) return null
              return new Chart(ctx, {
                type: 'line',
                data: { labels: Array(MAX_POINTS).fill(''), datasets: [{ label, data: Array(MAX_POINTS).fill(0), borderColor: color, tension: 0.3, borderWidth: 2, fill: true, backgroundColor: color + '20' }] },
                options: { ...commonOptions, scales: { ...commonOptions.scales, y: { ...commonOptions.scales.y, max: max || undefined } } }
              })
            }

            charts.cpu = createChart('chartCpu', '#3b82f6', 'CPU')
            charts.mem = createChart('chartMem', '#a855f7', 'Memory')
            charts.disk = createChart('chartDisk', '#22c55e', 'Disk')
            charts.net = createChart('chartNet', '#f97316', 'Network', null)
          })
        }

        // Watchers
        watch(tab, (newTab) => {
          if (newTab === 'performance') initCharts()
          else {
            // Destroy charts to free memory if needed, or keep them
            if (charts.cpu) {
              Object.values(charts).forEach(c => c?.destroy())
              charts = {}
            }
          }
          if (newTab === 'services') loadServices();
          // processes is polling based, but we could trigger one load
          if (newTab === 'processes') loadProcesses();
          // Initialize terminal on first switch
          if (newTab === 'terminal') {
            // Use nextTick to ensure container is rendered
            nextTick(() => {
              // Assuming 'this' context or 'app' is available, or pass it
              // For setup() context, 'this' is not the component instance.
              // You'd need to call initTerminal directly or via a ref.
              // If initTerminal is a function in setup(), call it directly.
              initTerminal();
            });
          }
          if (newTab === 'logs') {
            initLogs()
          }
        })

        async function loadStats() {
          try {
            const res = await axios.get('/api/monitor/stats')
            stats.value = res.data

            // Calculate Net Speed Global
            const now = Date.now()
            const dt = (now - lastNet.time) / 1000

            let sentKbs = 0, recvKbs = 0
            if (dt > 0 && lastNet.sent > 0) {
              sentKbs = (stats.value.net_sent - lastNet.sent) / 1024 / dt
              recvKbs = (stats.value.net_recv - lastNet.recv) / 1024 / dt
              netSpeed.value = {
                sent: sentKbs.toFixed(1),
                recv: recvKbs.toFixed(1)
              }
            }

            // Update Charts if active
            if (tab.value === 'performance' && charts.cpu) {
              const updateChart = (chart, val) => {
                if (!chart) return
                chart.data.datasets[0].data.push(val)
                chart.data.datasets[0].data.shift()
                chart.update()
              }

              updateChart(charts.cpu, stats.value.cpu_percent)
              updateChart(charts.mem, stats.value.memory_percent)
              updateChart(charts.disk, stats.value.disk_percent)

              if (dt > 0 && lastNet.sent > 0) {
                const totalKbs = sentKbs + recvKbs
                updateChart(charts.net, totalKbs)
              }
            }
            lastNet = { sent: stats.value.net_sent, recv: stats.value.net_recv, time: now }
          } catch { }
        }

        async function loadDB() {
          const [sum, sh, ps] = await Promise.all([
            axios.get('/api/admin/summary'),
            axios.get('/api/admin/shares'),
            axios.get('/api/admin/pins')
          ])
          summary.value = sum.data
          shares.value = Array.isArray(sh.data) ? sh.data : []
          pins.value = Array.isArray(ps.data) ? ps.data : []
        }

        async function loadServices() {
          try {
            const res = await axios.get('/api/services')
            services.value = res.data
          } catch (e) { console.error(e) }
        }

        async function loadProcesses() {
          try {
            const res = await axios.get('/api/processes')
            processes.value = res.data
          } catch (e) { console.error(e) }
        }

        async function loadScripts() {
          try {
            const res = await axios.get('/api/automation/scripts')
            scripts.value = res.data
            loadHistory()
          } catch (e) { console.error(e) }
        }

        async function loadHistory() {
          try {
            const res = await axios.get('/api/automation/history')
            jobHistory.value = res.data
          } catch (e) { console.error(e) }
        }

        // --- Actions ---
        async function svcAction(name, action) {
          if (!confirm(`Are you sure you want to ${action} service '${name}'?`)) return
          try {
            await axios.post(`/api/services/${name}`, { action })
            setTimeout(loadServices, 2000)
          } catch (e) {
            alert('Action failed: ' + (e.response?.data?.detail || e.message))
          }
        }

        async function killProcess(pid) {
          if (!confirm(`Are you sure you want to KILL process ${pid}? Data may be lost.`)) return
          try {
            await axios.post('/api/processes/kill', { pid })
            setTimeout(loadProcesses, 1000)
          } catch (e) {
            alert('Kill failed: ' + (e.response?.data?.detail || e.message))
          }
        }

        async function delShare(token) {
          if (!confirm('Delete this share?')) return
          await axios.delete('/api/admin/shares', { params: { token } })
          await loadDB()
        }

        async function delPin(id) {
          if (!confirm('Delete this pin?')) return
          await axios.delete('/api/admin/pins', { params: { id } })
          await loadDB()
        }

        async function delJob(id) {
          if (!confirm('Delete this job record?')) return
          await axios.delete(`/api/automation/jobs/${id}`)
          await loadHistory()
        }

        // --- Automation ---
        async function runScript(filename) {
          try {
            const res = await axios.post(`/api/automation/run/${filename}`)
            const jobId = res.data.job_id
            openJob(jobId)
          } catch (e) {
            alert('Failed to run script: ' + (e.response?.data?.detail || e.message))
          }
        }

        async function openJob(jobId) {
          showModal.value = true
          if (pollInterval) clearInterval(pollInterval)

          await fetchJob(jobId)
          pollInterval = setInterval(() => fetchJob(jobId), 1000)
        }

        async function fetchJob(jobId) {
          try {
            const res = await axios.get(`/api/automation/jobs/${jobId}`)
            currentJob.value = res.data

            // Auto scroll
            nextTick(() => {
              if (logBody.value) logBody.value.scrollTop = logBody.value.scrollHeight;
            })

            if (res.data.status !== 'running') {
              clearInterval(pollInterval)
              loadHistory() // refresh list
            }
          } catch {
            clearInterval(pollInterval)
          }
        }

        function closeModal() {
          showModal.value = false
          if (pollInterval) clearInterval(pollInterval)
          currentJob.value = null
        }

        // --- Computed / Helpers ---
        const filteredServices = computed(() => {
          if (!serviceFilter.value) return services.value
          const q = serviceFilter.value.toLowerCase()
          return services.value.filter(s =>
            s.name.toLowerCase().includes(q) ||
            s.display_name.toLowerCase().includes(q)
          )
        })

        // --- Terminal Logic ---
        function initTerminal() {
          if (term) return; // Already initialized

          // Create xterm instance
          term = new Terminal({
            cursorBlink: true,
            fontSize: 14,
            fontFamily: 'Consolas, "Courier New", monospace',
            theme: {
              background: '#1e1e1e',
              foreground: '#f0f0f0'
            }
          });

          // Load Fit Addon
          fitAddon = new FitAddon.FitAddon();
          term.loadAddon(fitAddon);

          // Open terminal in container
          term.open(document.getElementById('terminal-container'));
          fitAddon.fit();

          // Handle user input
          term.onData(data => {
            if (ws && ws.readyState === WebSocket.OPEN) {
              ws.send(data);
            }
          });

          // Handle resize
          window.addEventListener('resize', () => fitTerminal());

          connectTerminal();
        }

        function connectTerminal() {
          if (ws) {
            ws.close();
          }

          const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
          const wsUrl = `${protocol}//${window.location.host}/api/ws/console`;

          ws = new WebSocket(wsUrl);

          ws.onopen = () => {
            term.write('\r\n\x1b[32m[Connected to Server Terminal]\x1b[0m\r\n');
            fitTerminal();
          };

          ws.onmessage = (event) => {
            term.write(event.data);
          };

          ws.onclose = () => {
            term.write('\r\n\x1b[31m[Connection Closed]\x1b[0m\r\n');
          };

          ws.onerror = (err) => {
            term.write('\r\n\x1b[31m[Connection Error]\x1b[0m\r\n');
          };
        }

        function fitTerminal() {
          if (fitAddon) {
            fitAddon.fit();
            // Send resize command to backend if needed (console.py supports JSON resize)
            if (ws && ws.readyState === WebSocket.OPEN && term) {
              const dims = {
                type: 'resize',
                cols: term.cols,
                rows: term.rows
              };
              ws.send(JSON.stringify(dims));
            }
          }
        }

        function restartTerminal() {
          if (term) term.clear();
          connectTerminal();
        }

        function formatBytes(bytes) {
          if (bytes === 0) return '0 B';
          const k = 1024;
          const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatTime(ts) {
          if (!ts) return '-'
          try { return new Date(Number(ts) * 1000).toLocaleString() } catch { return String(ts) }
        }

        function getUsageClass(pct) {
          if (pct > 90) return 'high'
          if (pct > 70) return 'med'
          return ''
        }

        function toggleTheme() {
          theme.value = theme.value === 'dark' ? 'light' : 'dark'
          try { localStorage.setItem('rfe:theme', theme.value) } catch { }
          document.body.classList.toggle('dark', theme.value === 'dark')
        }

        onMounted(() => {
          // Theme init
          try {
            const t = localStorage.getItem('rfe:theme')
            if (t === 'dark') { theme.value = 'dark'; document.body.classList.add('dark') }
          } catch { }

          loadStats()
          loadDB()
          loadServices()
          loadProcesses()
          loadScripts()

          // Fast polling for realtime feel (500ms)
          setInterval(loadStats, 500)
        })

        return {
          tab, summary, stats, netSpeed, shares, pins, services, serviceFilter, processes, processFilter,
          apps, backgroundProcesses,
          filteredServices, theme, scripts, jobHistory, showModal, currentJob, logBody,
          // Terminal
          initTerminal, fitTerminal, restartTerminal,
          // Logs
          logs, toggleLogs, logContainer,
          loadServices, loadProcesses, loadScripts, svcAction, killProcess, delShare, delPin, delJob,
          runScript, openJob, closeModal,
          formatBytes, formatTime, getUsageClass, toggleTheme
        }
      }
    }).mount('#app')
  </script>
</body>

</html>